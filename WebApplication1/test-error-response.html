<!DOCTYPE html>
<html>
<head>
    <title>Error Response Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { margin: 10px 0; padding: 10px 20px; font-size: 16px; }
        #result { margin-top: 20px; padding: 10px; border: 1px solid #ccc; background-color: #f9f9f9; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
        .error { background-color: #ffe6e6; border-color: #ff0000; }
        .success { background-color: #e6ffe6; border-color: #00ff00; }
    </style>
</head>
<body>
    <h1>Error Response Test</h1>
    
    <h2>Test Registration with Error Capture</h2>
    <button onclick="testRegistrationWithError()">Test Registration</button>
    
    <div id="result"></div>

    <script>
        async function testRegistrationWithError() {
            const resultDiv = document.getElementById('result');
            
            try {
                // Get the registration page to extract the anti-forgery token
                const getResponse = await fetch('/Account/Register');
                const html = await getResponse.text();
                
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const token = doc.querySelector('input[name="__RequestVerificationToken"]');
                
                if (!token) {
                    throw new Error('Could not find anti-forgery token');
                }
                
                // Create form data
                const formData = new FormData();
                formData.append('__RequestVerificationToken', token.value);
                formData.append('FirstName', 'Test');
                formData.append('LastName', 'User');
                formData.append('Email', 'testuser' + Date.now() + '@example.com');
                formData.append('Username', 'testuser' + Date.now());
                formData.append('Password', 'Password123!');
                formData.append('ConfirmPassword', 'Password123!');
                formData.append('Role', 'Customer');
                formData.append('AcceptTerms', 'true');
                
                // Make the POST request
                const postResponse = await fetch('/Account/Register', {
                    method: 'POST',
                    body: formData
                });
                
                // Get the response text regardless of status
                const responseText = await postResponse.text();
                
                // Display the result
                resultDiv.className = '';
                resultDiv.innerHTML = `
                    <h3>Registration Response:</h3>
                    <p><strong>Status Code:</strong> ${postResponse.status} ${postResponse.statusText}</p>
                    <p><strong>URL:</strong> ${postResponse.url}</p>
                    <p><strong>Headers:</strong></p>
                    <pre>${JSON.stringify([...postResponse.headers.entries()], null, 2)}</pre>
                    <p><strong>Response Body:</strong></p>
                    <pre>${responseText}</pre>
                `;
                
                if (postResponse.status >= 400) {
                    resultDiv.classList.add('error');
                } else {
                    resultDiv.classList.add('success');
                }
                
            } catch (error) {
                resultDiv.className = 'error';
                resultDiv.innerHTML = `
                    <h3>Error:</h3>
                    <pre>${error.stack || error.message || error}</pre>
                `;
            }
        }
    </script>
</body>
</html>