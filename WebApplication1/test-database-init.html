<!DOCTYPE html>
<html>
<head>
    <title>Database Initialization Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        #results { margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 5px; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>
    <h1>Database Initialization Test</h1>
    
    <div class="test-section">
        <h3>Database Tests</h3>
        <button onclick="testDatabaseConnection()">Test Database Connection</button>
        <button onclick="checkDatabaseExists()">Check if Database Exists</button>
        <button onclick="initializeDatabase()">Initialize Database</button>
        <button onclick="testRegistration()">Test Registration</button>
    </div>

    <div class="test-section">
        <h3>Debug Information</h3>
        <button onclick="getDebugInfo()">Get Debug Info</button>
        <button onclick="clearDebugInfo()">Clear Debug Info</button>
    </div>

    <div id="results">
        <h3>Results:</h3>
        <pre id="output">Ready to test...</pre>
    </div>

    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            output.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }

        async function testDatabaseConnection() {
            clearOutput();
            log('Testing database connection...');
            
            try {
                const response = await fetch('/Database/TestConnection', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                log(`Response Status: ${response.status}`, response.ok ? 'success' : 'error');
                log(`Response: ${JSON.stringify(result, null, 2)}`, 'info');
                
                if (response.ok) {
                    log('Database connection test completed successfully', 'success');
                } else {
                    log('Database connection test failed', 'error');
                }
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }

        async function checkDatabaseExists() {
            clearOutput();
            log('Checking if database exists...');
            
            try {
                const response = await fetch('/Database/CheckExists', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                log(`Response Status: ${response.status}`, response.ok ? 'success' : 'error');
                log(`Response: ${JSON.stringify(result, null, 2)}`, 'info');
                
                if (response.ok) {
                    log('Database existence check completed', 'success');
                } else {
                    log('Database existence check failed', 'error');
                }
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }

        async function initializeDatabase() {
            clearOutput();
            log('Initializing database... This may take a moment.');
            
            try {
                const response = await fetch('/Database/InitializeDatabase', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                log(`Response Status: ${response.status}`, response.ok ? 'success' : 'error');
                log(`Response: ${JSON.stringify(result, null, 2)}`, 'info');
                
                if (response.ok) {
                    log('Database initialization completed successfully!', 'success');
                } else {
                    log('Database initialization failed', 'error');
                }
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }

        async function testRegistration() {
            clearOutput();
            log('Testing registration with sample data...');
            
            const testData = {
                FirstName: 'Test',
                LastName: 'User',
                Email: 'testuser' + Date.now() + '@example.com',
                Username: 'testuser' + Date.now(),
                Password: 'Test@123',
                ConfirmPassword: 'Test@123',
                PhoneNumber: '+27 82 123 4567',
                Address: '123 Test Street',
                City: 'Test City',
                Province: 'Gauteng',
                PostalCode: '1234',
                Role: 'Customer'
            };

            try {
                // First get the register page to obtain anti-forgery token
                const getResponse = await fetch('/Account/Register', {
                    method: 'GET'
                });
                
                if (!getResponse.ok) {
                    log('Failed to get registration page', 'error');
                    return;
                }
                
                const html = await getResponse.text();
                const tokenMatch = html.match(/name="__RequestVerificationToken" type="hidden" value="([^"]+)"/);
                
                if (!tokenMatch) {
                    log('Could not find anti-forgery token', 'error');
                    return;
                }
                
                const token = tokenMatch[1];
                log('Got anti-forgery token, proceeding with registration...');
                
                // Now submit the registration
                const formData = new URLSearchParams();
                formData.append('__RequestVerificationToken', token);
                for (const [key, value] of Object.entries(testData)) {
                    formData.append(key, value);
                }
                
                const postResponse = await fetch('/Account/Register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: formData.toString()
                });
                
                log(`Registration Response Status: ${postResponse.status}`, postResponse.ok ? 'success' : 'error');
                
                if (postResponse.ok) {
                    const resultText = await postResponse.text();
                    log('Registration completed successfully!', 'success');
                    log(`Response length: ${resultText.length} characters`);
                } else {
                    const errorText = await postResponse.text();
                    log('Registration failed', 'error');
                    log(`Error response: ${errorText.substring(0, 500)}...`);
                }
                
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }

        async function getDebugInfo() {
            try {
                const response = await fetch('/Debug/GetDebugInfo', {
                    method: 'GET'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log(`Debug Info: ${JSON.stringify(result, null, 2)}`, 'info');
                } else {
                    log('Failed to get debug info', 'error');
                }
            } catch (error) {
                log(`Error getting debug info: ${error.message}`, 'error');
            }
        }

        async function clearDebugInfo() {
            try {
                const response = await fetch('/Debug/ClearDebugInfo', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    log('Debug info cleared', 'success');
                } else {
                    log('Failed to clear debug info', 'error');
                }
            } catch (error) {
                log(`Error clearing debug info: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>